{% extends "base.html" %}
{% block title %}Фильмы — {{ genre if genre else 'Все' }}{% endblock %}

{% block content %}
{# Макро для форматирования продолжительности (мин -> "Hh Mm") #}
{% macro fmt_duration(mins) -%}
  {%- if mins is not none and mins|int > 0 -%}
    {%- set h = (mins|int) // 60 -%}
    {%- set m = (mins|int) % 60 -%}
    {{- (h > 0) and (h ~ 'h' ~ (m > 0 and ' ' or '')) or '' -}}
    {{- (m > 0) and (m ~ 'm') or '' -}}
  {%- endif -%}
{%- endmacro %}

<section class="panel">
  <div class="panel-head">
    <div style="display:flex;justify-content:space-between;align-items:center;">
      <div>
        <h3 class="panel-title">Фильмы: {{ genre if genre else 'Все' }}</h3>
        <div class="muted">Годы: {{ y_from }}—{{ y_to }} • найдено: {{ total }}</div>
      </div>

      <!-- Быстрая форма изменения диапазона прямо на странице результатов -->
      <form action="{{ url_for('search_genre') }}" method="get" style="display:flex; gap:.5rem; align-items:center;">
        {% if genre %}
          <input type="hidden" name="genre" value="{{ genre }}">
        {% endif %}
        <input type="number" name="y_from" min="{{ min_year }}" max="{{ max_year }}" value="{{ y_from }}" style="width:90px;">
        <span>—</span>
        <input type="number" name="y_to" min="{{ min_year }}" max="{{ max_year }}" value="{{ y_to }}" style="width:90px;">
        <button class="btn" type="submit">Фильтровать</button>
      </form>
    </div>
  </div>

  {% if results %}
    <div class="movies-grid">
      {# Сортируем результаты по release_year (по возрастанию). Если нужно — добавьте reverse=True для убывания. #}
      {% for r in results|sort(attribute='release_year') %}
        <article class="movie-card">
          <a class="poster" href="#" aria-label="{{ r.title }}" data-letter="{{ r.title.strip()[:1] | upper }}">
            {% if r.poster_url %}
              <img class="poster-img" src="{{ r.poster_url }}" alt="{{ r.title }}">
            {% else %}
              <div class="poster-fallback" aria-hidden="true"></div>
            {% endif %}

            <div class="poster-overlay">
              <div class="poster-title">{{ r.title }}</div>
            </div>
          </a>

          <div class="movie-info">
            <div class="movie-top">
              <div class="movie-meta-left">
                {% if r.release_year %}
                  <span class="movie-badge">{{ r.release_year }}</span>
                {% endif %}
                {% if r.duration %}
                  <span class="movie-badge movie-duration">{{ fmt_duration(r.duration) }}</span>
                {% endif %}
              </div>

              <div class="movie-meta-right">
                {% if r.imdb_rating %}
                  <a class="movie-imdb" href="{{ (r.imdb_url if r.imdb_url is defined else ('https://www.imdb.com/find?q=' ~ (r.title | urlencode))) }}" target="_blank" rel="noopener">
                    ★ {{ '%.1f'|format(r.imdb_rating|float) }}
                  </a>
                {% endif %}
                {% if r.rating %}
                  <span class="movie-rating">{{ r.rating }}</span>
                {% endif %}
              </div>
            </div>

            <div class="movie-genre">{{ r.genre if r.genre is defined else '' }}</div>
            {% if r.description %}
              <p class="movie-desc">{{ r.description }}</p>
            {% endif %}
          </div>
        </article>
      {% endfor %}
    </div>

    <div class="pager">
      {% if page > 1 %}
        <a class="btn" href="{{ url_for('search_genre', genre=genre, y_from=y_from, y_to=y_to, page=page-1) }}">&laquo; Предыдущие</a>
      {% endif %}
      <span class="muted">Стр. {{ page }}</span>
      {% if has_next %}
        <a class="btn btn-accent" href="{{ url_for('search_genre', genre=genre, y_from=y_from, y_to=y_to, page=page+1) }}">Следующие &raquo;</a>
      {% endif %}
    </div>
  {% else %}
    <p class="muted">Нет результатов.</p>
  {% endif %}
</section>
{% endblock %}