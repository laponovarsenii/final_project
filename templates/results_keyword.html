{% extends "base.html" %}
{% block title %}Результаты — Film Search{% endblock %}

{% block content %}
{# Макро для форматирования продолжительности (мин -> "Hh Mm") #}
{% macro fmt_duration(mins) -%}
  {%- if mins is not none and mins|int > 0 -%}
    {%- set h = (mins|int) // 60 -%}
    {%- set m = (mins|int) % 60 -%}
    {{- (h > 0) and (h ~ 'h' ~ (m > 0 and ' ' or '')) or '' -}}
    {{- (m > 0) and (m ~ 'm') or '' -}}
  {%- endif -%}
{%- endmacro %}

<section class="panel">
  <div class="panel-head">
    <div>
      <h3 class="panel-title">Результаты поиска</h3>
      <div class="muted">Запрос: «{{ q }}» • найдено: {{ total }}</div>
    </div>
  </div>

  {% if results %}
    <div class="movies-grid">
      {# Сортировка по году выхода (по возрастанию). Для обратного порядка: |sort(attribute='release_year', reverse=True) #}
      {% for r in results|sort(attribute='release_year') %}
        <article class="movie-card">
          <a class="poster" href="#" aria-label="{{ r.title }}" data-letter="{{ r.title.strip()[:1] | upper }}">
            {% if r.poster_url %}
              <img class="poster-img" src="{{ r.poster_url }}" alt="{{ r.title }}">
            {% else %}
              <div class="poster-fallback" aria-hidden="true"></div>
            {% endif %}

            <div class="poster-overlay">
              <div class="poster-title">{{ r.title }}</div>
            </div>
          </a>

          <div class="movie-info">
            <div class="movie-top">
              <div class="movie-meta-left">
                {% if r.release_year %}
                  <span class="movie-badge">{{ r.release_year }}</span>
                {% endif %}
                {% if r.duration %}
                  <span class="movie-badge movie-duration">{{ fmt_duration(r.duration) }}</span>
                {% endif %}
              </div>

              <div class="movie-meta-right">
                {% if r.imdb_rating %}
                  <a class="movie-imdb" href="{{ (r.imdb_url if r.imdb_url is defined else ('https://www.imdb.com/find?q=' ~ (r.title | urlencode))) }}" target="_blank" rel="noopener">
                    ★ {{ '%.1f'|format(r.imdb_rating|float) }}
                  </a>
                {% endif %}
                {% if r.rating %}
                  <span class="movie-rating">{{ r.rating }}</span>
                {% endif %}
              </div>
            </div>

            <div class="movie-genre">{{ r.genre if r.genre is defined else '' }}</div>
            {% if r.description %}
              <p class="movie-desc">{{ r.description }}</p>
            {% endif %}
          </div>
        </article>
      {% endfor %}
    </div>

    <div class="pager">
      {% if page > 1 %}
        <a class="btn" href="{{ url_for('search_keyword', q=q, page=page-1) }}">&laquo; Предыдущие</a>
      {% endif %}
      <span class="muted">Стр. {{ page }}</span>
      {% if has_next %}
        <a class="btn btn-accent" href="{{ url_for('search_keyword', q=q, page=page+1) }}">Следующие &raquo;</a>
      {% endif %}
    </div>
  {% else %}
    <p class="muted">Нет результатов.</p>
  {% endif %}
</section>
{% endblock %}